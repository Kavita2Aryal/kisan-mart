$image = $(".cropper-image > img");
$(document).on('click', '.crop-image', function (e) {
    e.preventDefault();
    var $parent = $(this).parent();
    var img = $parent.find('.image-image').val();
    if(img == '') return false;
    $image.attr('src', $parent.find('.image-src').val() + '/' + img);
    $('#image-name').val(img);
    $('.modal-media-crop').modal('show');

    setTimeout(function(){
        $image.cropper({
            aspectRatio: 1,
            modal: true,
            done: function(data) { }
        });
    }, 700);
});
$(document).on('click', '.crop-cancel', function (e) {
    e.preventDefault();
    $image.attr('src', ''); 
    $image.cropper('destroy');
});
$(document).on('click', '.crop-crop', function (e) {
    e.preventDefault();
    $.ajax({
        url: crop_url,
        type:'POST',
        data:{image_data: $image.cropper("getDataURL", "image/jpeg"), image_name: $('#image-name').val()},
        success: function(response) {
            if (response != false){
                notify_reload('info', 'Image has been cropped.');
            }
            else{
                notify_reload('danger', 'Something went wrong. please try again later.');
            }
        }  
    });
});
$(document).on('click', '.cropper-aspect-ratio', function (e) {
    e.preventDefault();
    $image.cropper('destroy');
    $image.cropper({
        aspectRatio: $(this).data('value'),
        modal: true,
        done: function(data) { }
    });
});
$(document).on('click', '.remove-image', function (e) {
    e.preventDefault();
    var $this = $(this);
    Swal.fire({
        title: 'Are you sure?',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
    }).then((result) => {
        if (result.value) {
            $.ajax({
                url: remove_url,
                type:'POST',
                data:{ image: $this.parents('.media-options').find('.image-image').val() },
                success: function(response) {
                    if (response.status == 'success') {
                        $this.parents('.media-parent').hide('fast', function () { $(this).remove(); });
                        notify_bar('success', 'Image has been deleted.'); 
                    }
                    else if (response.status == 'used') {
                        notify_bar('danger', 'Image is being used: ' + response.issue + ', under the title: "' + response.title + '"'); 
                    }
                    else { 
                        notify_reload('danger', 'Something went wrong. please try again later.');
                    }
                }  
            });
        }
    }); 
});
$(document).on('click', '.edit-image', function (e) {
    e.preventDefault();
    var $parent = $(this).parents('.media-options');
    var $modal = $('.modal-media-edit');
    $modal.find('.image-index').val($parent.find('.image-index').val());
    $modal.find('.image-caption').val($parent.find('.image-caption').val());
    $modal.find('.image-title').val($parent.find('.image-title').val());
    $modal.modal('show');
});
$(document).on('click', '.update-image-detail', function (e) {
    e.preventDefault();
    var $modal = $(this).parents('.modal-media-edit');
    var form = $modal.find('form');
    $.ajax({
        url: form.attr('action'),
        type:'POST',
        data:{
            image_caption: $modal.find('.image-caption').val(),
            image_title: $modal.find('.image-title').val(),  
            id: $modal.find('.image-index').val()
        },
        success: function(response) {
            if (response.status == 'success') {
                $modal.modal('hide');
                var $parent = $('.media-' + $modal.find('.image-index').val()); 
                $parent.find('.image-caption').val($modal.find('.image-caption').val());
                $parent.find('.image-title').val($modal.find('.image-title').val());
                notify_bar('success', 'Image detail has been updated.'); 
            }
            else {
                notify_bar('danger', 'Something went wrong. please try again later.');
            }
        }  
    });
});