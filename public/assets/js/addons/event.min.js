var $form = $('#event-form');
var content_index = $('.content-content').length;
$('[data-init-plugin=select2]').select2();
$('.event-date').daterangepicker();
$('.event-keywords input.form-control').tagsinput();
$(document).on('blur', '.event-keywords .bootstrap-tagsinput input', function (e) {
    if ($(this).val() != '') {
        $('.event-keywords input.form-control').tagsinput('add', $(this).val());
        $(this).val('');
    }
});
$('.content-content.content-description').each(function () {
    summernote_init($(this).data('indexing'));
});

var sortable_image_gallery = function () {
    $('.sortable.sortable-image').each(function () {
        sortable_image($('.sortable.sortable-image-'+$(this).data('sort-index'))); 
    });
}
var check_submission = function (e) {
    e.preventDefault();
    var check = $.ajax({
        url: $form.data('check'),
        data: $form.serialize(),
        type: 'PUT', async: false,
        success: function (response) { return response; }
    }).responseJSON;

    $('label.error').remove();
    if (check.hasOwnProperty("errors")) {
        var ie = 0;
        for (var key in check.errors) {
            if (check.errors.hasOwnProperty(key)) {
                ie++;
                var $error = null;
                var keys = key.split('.');
                if (keys.length == 1) {
                    $error = $('[name=' + key + ']');
                }
                else if (keys.length == 2) {
                    $error = $('[name="' + keys[0] + '[' + keys[1] + ']"]');
                }
                else if (keys.length == 3) {
                    $error = $('[name="' + keys[0] + '[' + keys[1] + '][' + keys[2] + ']"]');
                }

                if ($error != null) {
                    $error.parents('.form-group').after('<label class="error">' + check.errors[key] + '</label>');
                }
            }
        }
        notify_bar('danger', 'Please fill all the required data before proceeding.'); return false;
    }
    return true;
}
var generate_form = function (type) {
    content_index++;
    $.ajax({
        url: $form.data('generate'),
        type: 'POST',
        data: { type: type, index: content_index },
        async: false,
        success: function (response) {
            $('.content-container').append(response.html);
            if (type == 'description') summernote_init(content_index);
            else if (type == 'image_gallery') sortable_image_gallery();
        }
    });
}

summernote_init();
sortable_image_gallery();

$(document).on('click', '.btn-remove', function (e) {
    e.preventDefault();
    var $this = $(this);
    Swal.fire({
        title: 'Are you sure?',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
    }).then((result) => {
        if (result.value) {
            $this.parents('.content-content').hide('fast', function () { $(this).remove(); });
        }
    });
});
$(document).on('click', '.btn-add-content', function (e) {
    e.preventDefault();
    generate_form($(this).data('content'));
});
$(document).on('click', '.btn-submit', function (e) {
    e.preventDefault();
    if (check_submission(e)) {
        setTimeout(function () { $form.submit(); }, 500);
    }
});