var $form = $('.page-management form');
$('#zoomer').rangeslider({polyfill: false})
.on('input', function (e) { 
    e.preventDefault();
    $('#receive-section').find('.section-container').css('width', $(this).val()+'%'); 
});

var sort_display_order = function () { 
    var ix=0;
    $('#receive-section').find('.section-item').each( function () {
        $(this).find('.section-order').val(++ix);
    });
}

var filter_content = function () {
    $('#send-section').find('.section-item').hide();
    $('#filter-section').find('.filter-item:checked').each( function () {
        $('#send-section').find($(this).val()).show();
    });
}

var hide_drop_info = function () {
    if ($('.section-container-info').css('display') != 'none') {
        $('.section-container-info').hide(); 
    }
}

var show_drop_info = function () {
    if ($('#receive-section').find('.section-item').length == 0) { 
        $('.section-container-info').show(); 
    }
}

var send_option = {
    easing: "cubic-bezier(1, 0, 0, 1)",
    group: { name: 'shared', pull: 'clone', put: false }, 
    animation: 150, 
    sort: false,
    onEnd: function (evt) { 
        hide_drop_info();
        if ($(evt.item).hasClass('header-item')) {
            if ($('#receive-section').find('.header-item').length > 1) {
                $('#receive-section').find('.header-item').not(evt.item).hide('fast', function () { $(this).remove(); });
            }
            $(evt.item).prependTo($(evt.to));
        }
        else if ($(evt.item).hasClass('footer-item')) {
            if ($('#receive-section').find('.footer-item').length > 1) {
                $('#receive-section').find('.footer-item').not(evt.item).hide('fast', function () { $(this).remove(); });
            }
            $(evt.item).appendTo($(evt.to));
        }
        else if ($(evt.item).hasClass('section-item')) {
            var index = indexing();
            $(evt.item).find('.section-index').attr('name', 'sections['+index+'][index]');
            $(evt.item).find('.section-order').attr('name', 'sections['+index+'][display_order]');
            sort_display_order();
        }
    }
};

var receive_option = {
    easing: "cubic-bezier(1, 0, 0, 1)",
    group: { name: 'shared'}, 
    animation: 150, 
    sort: true,
    onEnd: function (evt) { },
    onSort: function (evt) {
        if ($(evt.item).hasClass('header-item')) {
            $(evt.item).prependTo($(evt.to));
        }
        else if ($(evt.item).hasClass('footer-item')) {
            $(evt.item).appendTo($(evt.to));
        }
        else if ($(evt.item).hasClass('section-item')) {
            $('#receive-section').find('.header-item').prependTo($(evt.to));
            $('#receive-section').find('.footer-item').appendTo($(evt.to));
            sort_display_order();
        }
    }
};

new Sortable(document.getElementById('send-section').getElementsByClassName('section-container')[0], send_option);
new Sortable(document.getElementById('receive-section').getElementsByClassName('section-container')[0], receive_option);

$(document).on('change', '.filter-item', function (e) { filter_content(); });

$(document).on('change', '#filter-all-section', function (e) {
    $('.filter-item').prop('checked', $(this).is(':checked'));
    filter_content();
});

$(document).on('change', '#filter-all-header', function (e) {
    if ($(this).is(':checked')) {
        $('#send-section').find('.header-item').show();
    }
    else {
        $('#send-section').find('.header-item').hide();
    }
});

$(document).on('change', '#filter-all-footer', function (e) {
    if ($(this).is(':checked')) {
        $('#send-section').find('.footer-item').show();
    }
    else {
        $('#send-section').find('.footer-item').hide();
    }
});

$(document).on('click', '.btn-filter-section', function (e) {
    e.preventDefault();
    $('#filter-section').toggle();
});

$(document).on('click', '.btn-filter-section-close', function (e) {
    e.preventDefault();
    $('#filter-section').hide();
});

$(document).on('click', '#send-section .header-item', function (e) { 
    e.preventDefault();
    if ($('#receive-section').find('.header-item').length == 1) {
        $('#receive-section').find('.header-item').hide('fast', function () { $(this).remove(); });
    }
    $('#receive-section').find('.section-container').prepend($(this).clone());
    $('#receive-section').animate({ scrollTop: 0}, 500);
});

$(document).on('click', '#send-section .footer-item', function (e) { 
    e.preventDefault();
    if ($('#receive-section').find('.footer-item').length == 1) { 
        $('#receive-section').find('.footer-item').hide('fast', function () { $(this).remove(); });
    } 
    $('#receive-section').find('.section-container').append($(this).clone());
    $('#receive-section').animate({ scrollTop: $('#receive-section').prop("scrollHeight")}, 500);
});

$(document).on('click', '#send-section .section-item', function (e) { 
    e.preventDefault();
    hide_drop_info();
    var index = indexing();
    var $cloned = $(this).clone(); 
    $cloned.find('.section-index').attr('name', 'sections['+index+'][index]');
    $cloned.find('.section-order').attr('name', 'sections['+index+'][display_order]');

    if ($('#receive-section').find('.footer-item').length == 1) {
        $('#receive-section').find('.footer-item').before($cloned);
    }   
    else { 
        $('#receive-section').find('.section-container').append($cloned); 
    }
 
    $('#receive-section').animate({ scrollTop: $('#receive-section').prop("scrollHeight")}, 500);
    sort_display_order();
});

$(document).on('click', '.content-tools .btn-remove', function (e) {
    e.preventDefault();
    var $this = $(this);
    Swal.fire({
        title: 'Are you sure?',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
    }).then((result) => {
        if (result.value) {
            $this.parents('.content-item').hide('fast', function () { 
                $(this).remove(); show_drop_info(); sort_display_order();
            });
        }
    }); 
});

$(document).on('click', '.btn-submit', function (e) {
    e.preventDefault();
    if ($('#receive-section').find('.section-item').length == 0) {
        notify_bar('danger', 'Please add at least one section before proceeding.'); return false;
    }
    else if ($(this).data('type') == 'edit') {
        Swal.fire({
            title: 'Are you sure?',
            text: "",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, update it!'
        }).then((result) => {
            if (result.value) {
                $form.submit();
            }
        });
    }
    else {
        $form.submit();
    }
});