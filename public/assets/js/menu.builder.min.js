var editor = null;
$(document).ready( function () {
    var design = $.trim(design_data); 
    editor = new MenuEditor('menu-builder');
    editor.setForm($('.menu-builder .menu-form'));
    editor.setInputURL($('.menu-builder .input-url'));
    editor.setAddButton($('.menu-builder .btn-add'));
    editor.setUpdateButton($('.menu-builder .btn-update'));

    if (design != "" && design != 'undefined'){
        design = JSON.parse(design.replace(/&quot;/g,'"').replace(/&#039;/g, "'").replace(/&amp;/g, "&").replace(/&lt;/g, "<").replace(/&gt;/g, "/>"));
        editor.setData(JSON.stringify(design));
    }
});
$(document).on('click', '.menu-builder .btn-update', function (e) { 
    e.preventDefault(); 
    var full_path = $('.populate-media').find('img').attr('src');
    var image_aray = full_path.split("/");
    var image = image_aray.length > 0 ? image_aray.slice(-1).pop() : '';
    var image_name = image.split("?");
    var image = image_name.length > 0 ? image_name.slice(0, 1) : ''; 
    $('[name=image]').val(image);
    $('[name=image_preview]').val(full_path);
    editor.update(); 
});
$(document).on('click', '.menu-builder .btn-add', function (e) { 
    e.preventDefault(); 
    var full_path = $('.populate-media').find('img').attr('src');
    var image_aray = full_path.split("/");
    var image = image_aray.length > 0 ? image_aray.slice(-1).pop() : '';
    var image_name = image.split("?");
    var image = image_name.length > 0 ? image_name.slice(0, 1) : '';
    $('[name=image]').val(image);
    $('[name=image_preview]').val(full_path);
    editor.add(); 
});
$(document).on('click', '.menu-builder .btn-add-selected', function (e) { 
    e.preventDefault(); 
    var obj = JSON.parse(editor.getString());
    $(this).parents('.menu-parent').find('.menu-check:checked').each( function () {
        var $item = $(this);
        obj.push({
            text: $item.data('text'),
            href: $item.data('href'), 
            target: $item.data('target'),
            index: $item.data('index'), 
            type: $item.data('type'), 
            image: $item.data('image')
        });
        $item.prop('checked', false);
    });
    editor.setData(JSON.stringify(obj));
});
$(document).on('click', '.menu-builder [data-toggle="collapse"]', function (e) {
    e.preventDefault();
    $('.card-group').find('.collapse').removeClass('show');
    $('.card-group').find('[data-toggle="collapse"]').addClass('collapsed');
    $(this).parents('.card').find('.collapse').addClass('show');
    $(this).removeClass('collapsed');
});
$(document).on('click', '.menu-builder .btnEdit.clickable', function (e) {
    e.preventDefault();
    $('.card-group').find('.collapse').removeClass('show');
    $('.card-group').find('[data-toggle="collapse"]').addClass('collapsed');
    $('#collapse-custom').addClass('show');
    $('[href="#collapse-custom"]').removeClass('collapsed');
});
$(document).on('click', '.menu-builder .btn-save', function (e) { 
    e.preventDefault(); 
    $.ajax({
        url: save_url,
        type: 'POST',
        data: { design: editor.getString(), menu_type: $('#menu-type').val(), same_as_desktop: ($('#same-as-desktop').is(':checked') ? 10 : 0) },
        async: false,
        success: function (response) {
            (response) ? notify_bar('success', 'Website menu has been updated.') : notify_bar('danger', 'Something went wrong. please try again later.');
        },
        statusCode: {
            500: function () { notify_bar('danger', 'Something went wrong. please try again later.'); },
            422: function () { notify_bar('danger', 'Something went wrong. please try again later.'); },
            403: function () { notify_bar('danger', 'Something went wrong. please try again later.'); }
        }
    }) 
});
$(document).on('click', '.remove-use-media-menu', function (e) {
    e.preventDefault();
    $('.populate-value-menu').val(0);
    $('.populate-container').hide();
    $('.populate-media').find('img').attr('src', '');
    $('.populate-media').find('a').attr('href', '');
});
$(document).on('change', '#same-as-desktop', function (e) {
    $(this).is(':checked') ? $('.menu-options').hide() : $('.menu-options').show();
});