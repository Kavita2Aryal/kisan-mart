$(document).ready(function () {
    $('.collection-select-init').select2();
    $('#tableWithSearch').dataTable();
});
$(document).on('click', '#search-prod-item', function (e) {
    e.preventDefault();
    var categories = $("#search-category-listing").val();
    var brands = $("#search-brand-listing").val();
    var product = $("#search-product-listing").val();
    if (categories.length > 0 || brands.length > 0 || product !== '') {
        $.ajax({
            type: 'GET',
            data: { categories: categories, brands: brands, product: product },
            url: get_filter_products,
            async: false,
            success: function (response) {
                if (response.status) {
                    $(".save-selected-product, .save-selected-product-offer, .select-all-products").css('display', 'inline-block');
                    $("#option-product-listing").html(response.html)
                }
                else {
                    $(".save-selected-product, .save-selected-product-offer, .select-all-products").css('display', 'none');
                    $("#option-product-listing").html('<div><h4>No Products Found!</h4></div>');
                }   
            }
        });
    }
    else {
        notify_bar('danger', 'Please select at leat one category or brand or enter product name.');
    }
});
$(document).on('click', '.save-selected-product', function (e) {
    e.preventDefault();
    if ($("input:checkbox:checked").length == 0) {
        notify_bar('danger', 'Please check at leat one product.');
    }
    else {
        $('#manage-products-save-form').submit();
    }
});
$(document).on('click', '.remove-selected-product', function (e) {
    e.preventDefault();
    if ($("input[name='selected_product']:checked").length > 0) {
        Swal.fire({
            title: 'Are you sure?',
            text: "",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.value) {
                var arr = [];
                $("input[name='selected_product']:checked").each(function () {
                    arr.push(this.value);
                });
                $.ajax({
                    type: 'PUT',
                    data: { products: arr },
                    url: remove_selected_product,
                    async: false,
                    success: function (res) {
                        if (res.status) {
                            notify_reload('success', 'Selected Product has been removed');
                        }
                    }
                });
            }
        });
    } 
    else {
        notify_bar('danger', 'Please check at leat one product.');
    }
});

$(document).on('click', '.order-remove-selected-product', function (e) {
    e.preventDefault();
    if ($("input[name='selected_product']:checked").length > 0) {
        Swal.fire({
            title: 'Are you sure?',
            text: "",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, remove it!'
        }).then((result) => {
            if (result.value) {
                var arr = [];
                $("input[name='selected_product']:checked").each(function () {
                    arr.push(this.value);
                    $('.tr-'+this.value).remove();
                });
                $.ajax({
                    type: 'PUT',
                    data: { products: arr },
                    url: remove_selected_product,
                    async: false,
                    success: function (res) {
                        if (res.status) {
                            notify_bar('success', 'Selected Product has been removed');
                        }
                    }
                });
            }
        });
    } 
    else {
        notify_bar('danger', 'Please check at leat one product.');
    }
});

$(document).on('click', '#open-product-listing', function (e) {
    e.preventDefault();
    $('#product-listing').modal('show');
});
$(document).on('click', '.uncheck-all-products', function (e) {
    e.preventDefault();
    var checked_products = $("input[name='selected_product']:checked").length;
    if (checked_products > 0) {
        $(this).text('SELECT ALL');
        $("input[name='selected_product']").prop('checked', false);
    }
    $(this).removeClass('uncheck-all-products').addClass('check-all-products');
});
$(document).on('click', '.check-all-products', function (e) {
    e.preventDefault();
    $(this).text('UNSELECT ALL');
    $("input[name='selected_product']").prop('checked', true);
    $(this).removeClass('check-all-products').addClass('uncheck-all-products');
});
$(document).on('click', '.select-all-products', function (e) {
    e.preventDefault();
    $(this).text('UNSELECT ALL');
    $(".product-search").prop('checked', true);
    $(this).removeClass('select-all-products').addClass('unselect-all-products');
});
$(document).on('click', '.unselect-all-products', function (e) {
    e.preventDefault();
    var checked_products = $(".product-search").length;
    if (checked_products > 0) {
        $(this).text('SELECT ALL');
        $(".product-search").prop('checked', false);
    }
    $(this).removeClass('unselect-all-products').addClass('select-all-products');
});

$(document).on('click', '.save-selected-product-offer', function (e) {
    e.preventDefault(); 
    var discount = $('.discount-entry .offer-discount').val();
    if (discount == '') {
        notify_bar('danger', 'Please enter offer discount.');
    }
    else if (discount < 0) {
        notify_bar('danger', 'Please enter offer discount greater than or equal to 0.');
    }
    else if ($('.discount-entry .offer-discount').data('type') == 'percent' && discount > 100) {
        notify_bar('danger', 'Please enter offer discount less than or equal to 100.');
    }
    else if ($("input:checkbox:checked").length == 0) {
        notify_bar('danger', 'Please check at leat one product.');
    }
    else {
        $('#manage-products-offer-save-form').submit();
    }
});
$(document).on('click', '.update-discount', function (e) {
    e.preventDefault();
    if ($(".offer-table .offer-discount").length > 0) {
        Swal.fire({
            title: 'Are you sure?',
            text: "",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, update it!'
        }).then((result) => {
            if (result.value) {
                var arr = [];
                $(".offer-table .offer-discount").each(function () {
                    arr.push({ 'index': $(this).data('product'), 'discount': $(this).val() });
                }); console.log(arr);
                $.ajax({
                    type: 'PUT',
                    data: { products: arr },
                    url: discount_update,
                    async: false,
                    success: function (res) {
                        if (res.status) {
                            notify_bar('success', 'Product discount has been updated');
                        }
                    }
                });
            }
        });
    } 
    else {
        notify_bar('danger', 'Please update product discount before submitting.');
    }
});

$(document).on('click', '.update-selected-product', function (e) {
    e.preventDefault();
    var $this = $(this);
    var index = $this.data('product');
    var qty = $('.order-selected-items-table').find('#qty-'+index).val();
    var actual_price = $('.order-selected-items-table').find('#actual-price-'+index).val();
    var price = $('.order-selected-items-table').find('#price-'+index).val();
    var sku = $('.order-selected-items-table').find('#variant-'+index).val();
    console.log(index, qty, actual_price, price, sku);
    Swal.fire({
        title: 'Are you sure?',
        text: "",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, update it!'
    }).then((result) => {
        if (result.value) {
            $.ajax({
                type: 'PUT',
                data: { product_id: index, qty: qty, actual_price: actual_price, price: price, sku: sku },
                url: update_selected_product,
                async: false,
                success: function (res) {
                    if (res.status) {
                        notify_reload('success', 'Item has been updated');
                    }else{
                        notify_bar('danger', 'Something went wrong! Please try again.')
                    }
                }
            });
        }
    });
});